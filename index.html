<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur de Documents CHUSM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Animation du fond */
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .animated-bg {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }
        /* Styles modernes */
        .glass-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        .modern-btn {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .modern-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        .modern-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }
        .modern-btn:hover::before {
            left: 100%;
        }
        .floating { animation: floating 3s ease-in-out infinite; }
        @keyframes floating {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        .text-glow { text-shadow: 0 0 10px rgba(255, 255, 255, 0.8); }

        /* Styles pour les formulaires spécifiques (issus du code 2) */
        .form-container-wrapper { /* Wrapper pour chaque formulaire interne */
            background-color: rgba(255, 255, 255, 0.05); /* Léger fond pour distinguer */
            padding: 20px;
            border-radius: 15px;
            color: white; /* Assurer que le texte est lisible */
        }
        .form-container-wrapper h1, .form-container-wrapper h2 {
            text-align: center;
            color: white; /* S'assurer que les titres sont blancs */
            margin-bottom: 20px;
        }
        .form-container-wrapper .form-group { margin-bottom: 15px; }
        .form-container-wrapper label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: white; /* Labels en blanc */
        }
        .form-container-wrapper input[type="text"],
        .form-container-wrapper input[type="date"],
        .form-container-wrapper input[type="time"],
        .form-container-wrapper textarea,
        .form-container-wrapper select {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            box-sizing: border-box;
            background-color: rgba(255,255,255,0.1);
            color: white;
            backdrop-filter: blur(2px);
        }
        .form-container-wrapper input[type="text"]::placeholder,
        .form-container-wrapper textarea::placeholder {
            color: rgba(255,255,255,0.7);
        }
         .form-container-wrapper input[type="radio"]{
            margin-right: 8px;
         }

        .form-container-wrapper button, .form-container-wrapper .add-member, .form-container-wrapper .add-piece {
            background-color: rgba(0, 123, 255, 0.5); /* Couleur de bouton adaptée */
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            display: block;
            margin: 20px auto 0 auto;
            transition: background-color 0.3s ease;
        }
        .form-container-wrapper button:hover, .form-container-wrapper .add-member:hover, .form-container-wrapper .add-piece:hover {
            background-color: rgba(0, 100, 200, 0.7);
        }
        .form-container-wrapper .remove-member, .form-container-wrapper .remove-piece {
            background-color: rgba(220, 53, 69, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            height: 28px;
            width: 28px;
            text-align: center;
            font-size: 18px;
            margin-left: 10px;
        }
        .form-container-wrapper .member-item, .form-container-wrapper .piece-item {
            display: flex;
            margin-bottom: 8px;
            align-items: center;
        }
        .form-container-wrapper .member-item input, .form-container-wrapper .piece-item input,
        .form-container-wrapper .member-item select {
            flex-grow: 1;
        }

        /* Styles pour la zone de rendu PDF (communs à plusieurs formulaires) */
        .pdf-render-area {
            position: absolute;
            left: -9999px;
            top: auto;
            width: 210mm; /* A4 width */
            background: white;
            color: #000; /* Texte noir sur fond blanc pour le PDF */
        }
        .bordereau-content-pdf { /* Style spécifique pour les bordereaux PDF */
            font-family: Arial, sans-serif;
            font-size: 10pt;
            color: #000;
            line-height: 1.3;
            width: 100%;
            box-sizing: border-box;
            padding: 15mm;
            position: relative;
            min-height: 270mm; /* A4 height minus margins */
            display: flex;
            flex-direction: column;
        }
        .bordereau-content-pdf .header-pdf {
            text-align: center;
            margin-bottom: 5mm;
            flex-shrink: 0;
        }
        .bordereau-content-pdf .header-pdf img {
            max-width: 180mm; height: auto; display: block; margin: 0 auto 10px;
        }
        .bordereau-content-pdf .header-pdf p { margin: 1px 0; font-size: 11pt; }
        .bordereau-content-pdf .header-pdf p strong { font-weight: bold; }
        .bordereau-content-pdf table {
            width: 100%; border-collapse: collapse; border: 1px solid #000;
            table-layout: fixed; margin-top: 10px; margin-bottom: 20px;
        }
        .bordereau-content-pdf th, .bordereau-content-pdf td {
            border: 1px solid #000; padding: 6px; text-align: left;
            vertical-align: top; font-size: 10pt; word-wrap: break-word;
        }
        .bordereau-content-pdf th { background-color: #f2f2f2; font-weight: bold; text-align: center; }
        .bordereau-content-pdf .designations { width: 40%; }
        .bordereau-content-pdf .nbre { width: 15%; text-align: center;}
        .bordereau-content-pdf .observations { width: 45%; text-align: justify;}
        .bordereau-content-pdf ul { list-style-type: disc; margin: 5px 0 5px 20px; padding-left: 0; }
        .bordereau-content-pdf li { margin-bottom: 2px; }
        .bordereau-content-pdf pre {
            font-family: Arial, sans-serif; font-size: 10pt; margin: 5px 0;
            white-space: pre-wrap; line-height: 1.3; padding-left: 0;
        }
        .bordereau-content-pdf strong { font-weight: bold; }
        .bordereau-content-pdf .footer-pdf {
            text-align: center; margin-top: auto; /* Push footer to bottom */
            padding-top: 5mm; width: 100%;
            /* position: absolute; bottom: 1mm; left: 0; Ensure this works with flex parent */
        }
         .bordereau-content-pdf .footer-pdf img {
            max-width: 180mm; height: auto; display: block; margin: 0 auto;
        }

        /* Styles pour Convocation (formulaire et PDF) */
        #convocation-form-wrapper .generator-container { max-width: 700px; margin: auto; }
        #convocation-form-wrapper .section-buttons button {
            background-color: rgba(255,255,255,0.2); padding: 8px 12px; margin-right: 5px;
            border-radius: 5px; cursor: pointer; color:white; border: 1px solid rgba(255,255,255,0.3);
        }
        #convocation-form-wrapper .section-buttons button.active { background-color: rgba(0,123,255,0.7); }
        #convocation-form-wrapper .recipient-list { margin-top: 10px; max-height: 200px; overflow-y: auto; padding:10px; background:rgba(0,0,0,0.1); border-radius:8px;}
        #convocation-form-wrapper .checkbox-group, #convocation-form-wrapper .select-all-group { margin-bottom: 5px; display: flex; align-items: center; }
        #convocation-form-wrapper input[type="checkbox"] { margin-right: 8px; width:auto; }

        /* Styles pour Décision (formulaire) */
        #decision-form-wrapper .radio-group { display: flex; gap: 20px; margin-bottom:10px;}
        #decision-form-wrapper .radio-option { display: flex; align-items: center; }
        #decision-form-wrapper .radio-option input { width: auto; margin-right: 5px; }
        #decision-form-wrapper .members-container { margin-top: 15px; }

        /* Styles spécifiques pour le formulaire de demande de complément */
        #complement-form-wrapper .mode-selector {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            gap: 15px;
        }
        #complement-form-wrapper .mode-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        #complement-form-wrapper .mode-btn.active {
            background-color: rgba(67, 97, 238, 0.7);
            color: white;
        }
        #complement-form-wrapper .mode-btn:hover:not(.active) {
            background-color: rgba(233, 236, 239, 0.3);
        }
        #complement-form-wrapper .form-section {
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.05);
        }
        #complement-form-wrapper .section-title {
            color: white;
            margin-bottom: 15px;
            font-size: 1.2rem;
            font-weight: 500;
            display: flex;
            align-items: center;
        }
        #complement-form-wrapper table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            overflow: hidden;
        }
        #complement-form-wrapper th, #complement-form-wrapper td {
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 12px;
            text-align: left;
            vertical-align: top;
            background-color: rgba(255, 255, 255, 0.05);
        }
        #complement-form-wrapper th {
            background-color: rgba(255, 255, 255, 0.1);
            font-weight: 500;
            color: white;
        }
        #complement-form-wrapper .conditions-container .condition-item {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }
        #complement-form-wrapper .error-message {
            color: #f72585;
            font-size: 0.85rem;
            margin-top: 5px;
        }
        #complement-form-wrapper .hidden {
            display: none !important;
        }
        #complement-form-wrapper .document-content {
            width: 210mm;
            min-height: 297mm;
            padding: 5mm 20mm 20mm 20mm;
            box-sizing: border-box;
            font-size: 16px;
            line-height: 1.6;
            position: relative;
            background: white;
            font-family: 'Dubai', Arial, sans-serif;
            color: black;
        }
        #complement-form-wrapper .document-content p {
            margin: 10px 0;
        }
        #complement-form-wrapper .document-content .justify-text {
            text-align: justify;
        }
        #complement-form-wrapper .document-content ul {
            padding-left: 20px;
        }
        #complement-form-wrapper .document-content li {
            text-align: justify;
            margin-bottom: 10px;
        }
        @media (max-width: 768px) {
            #complement-form-wrapper .form-group {
                flex-direction: column;
                align-items: flex-start;
            }
            #complement-form-wrapper .form-group label {
                min-width: auto;
                margin-bottom: 5px;
            }
            #complement-form-wrapper .form-control {
                width: 100%;
            }
            #complement-form-wrapper .mode-selector {
                flex-direction: column;
                align-items: center;
            }
            #complement-form-wrapper .mode-btn {
                width: 100%;
                max-width: 300px;
            }
            #complement-form-wrapper table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body class="animated-bg min-h-screen text-white font-sans antialiased overflow-x-hidden">
    <div id="app" class="min-h-screen flex flex-col items-center justify-center p-4">
        <!-- Écran de connexion -->
        <div id="login-screen" class="w-full max-w-md glass-card p-8 rounded-2xl">
            <div class="text-center mb-8">
                <div class="floating inline-block mb-4">
                    <i class="fas fa-lock text-5xl text-white"></i>
                </div>
                <h1 class="text-3xl font-bold text-white text-glow">Accès sécurisé</h1>
                <p class="text-white/80 mt-2">Veuillez entrer le mot de passe pour continuer</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="password" class="block text-sm font-medium text-white mb-2">Mot de passe</label>
                    <div class="relative">
                        <input type="password" id="password" class="modern-btn w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-white/50 placeholder-white/70" placeholder="••••••••" required>
                        <div class="absolute right-3 top-3"><i class="fas fa-key text-white/70"></i></div>
                    </div>
                </div>
                <div id="error-message" class="bg-red-500/80 text-white text-sm p-3 rounded-lg hidden flex items-center">
                    <i class="fas fa-exclamation-circle mr-2"></i> Mot de passe incorrect
                </div>
                <button type="submit" class="modern-btn w-full bg-white/20 hover:bg-white/30 text-white font-medium py-3 px-4 rounded-xl transition duration-200 flex items-center justify-center">
                    <span>Valider</span><i class="fas fa-arrow-right ml-2"></i>
                </button>
            </form>
        </div>

        <!-- Menu principal (caché initialement) -->
        <div id="main-menu" class="hidden w-full max-w-6xl">
            <header class="mb-10 text-center">
                <h1 class="text-4xl md:text-5xl font-bold text-white text-glow mb-2">Générateur de Documents</h1>
                <p class="text-xl text-white/80">Sélectionnez une option ci-dessous</p>
            </header>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6">
                <div class="glass-card p-6 flex flex-col items-center justify-center transition-all duration-300 hover:scale-105 cursor-pointer h-48" onclick="handleOptionClick(1)">
                    <div class="bg-blue-500/20 p-4 rounded-full mb-4 text-white"><i class="fas fa-file-alt text-3xl"></i></div>
                    <h3 class="text-lg font-semibold text-center">CONVOCATION</h3>
                </div>
                <div class="glass-card p-6 flex flex-col items-center justify-center transition-all duration-300 hover:scale-105 cursor-pointer h-48" onclick="handleOptionClick(2)">
                    <div class="bg-purple-500/20 p-4 rounded-full mb-4 text-white"><i class="fas fa-paper-plane text-3xl"></i></div>
                    <h3 class="text-lg font-semibold text-center">BORDEREAU V1</h3>
                </div>
                <div class="glass-card p-6 flex flex-col items-center justify-center transition-all duration-300 hover:scale-105 cursor-pointer h-48" onclick="handleOptionClick(3)">
                    <div class="bg-green-500/20 p-4 rounded-full mb-4 text-white"><i class="fas fa-file-export text-3xl"></i></div>
                    <h3 class="text-lg font-semibold text-center">BORDEREAU FINAL</h3>
                </div>
                <div class="glass-card p-6 flex flex-col items-center justify-center transition-all duration-300 hover:scale-105 cursor-pointer h-48" onclick="handleOptionClick(4)">
                    <div class="bg-yellow-500/20 p-4 rounded-full mb-4 text-white"><i class="fas fa-gavel text-3xl"></i></div>
                    <h3 class="text-lg font-semibold text-center">DÉCISION</h3>
                </div>
                <div class="glass-card p-6 flex flex-col items-center justify-center transition-all duration-300 hover:scale-105 cursor-pointer h-48" onclick="handleOptionClick(5)">
                    <div class="bg-red-500/20 p-4 rounded-full mb-4 text-white"><i class="fas fa-tools text-3xl"></i></div>
                    <h3 class="text-lg font-semibold text-center">DEMANDE COMPLÉMENT</h3>
                </div>
            </div>
        </div>

        <!-- Conteneurs pour les différents formulaires (initialement cachés) -->
        <div id="form-containers" class="hidden w-full max-w-4xl mx-auto glass-card p-8 rounded-2xl backdrop-blur-lg mt-10 mb-10">
            <button id="backToMenuBtn" class="modern-btn absolute top-6 right-6 z-20 px-4 py-2 rounded-xl bg-white/20 hover:bg-white/30 text-white flex items-center">
                <i class="fas fa-arrow-left mr-2"></i>Retour au Menu
            </button>

            <!-- Formulaire CONVOCATION -->
            <div id="convocation-form-wrapper" class="hidden form-container-wrapper">
                <h1>Générateur de Convocation</h1>
                <p class="text-center mb-6">Remplissez les informations ci-dessous pour générer les lettres de convocation.</p>
                <form id="convocationFormInternal" onsubmit="return false;">
                    <h2>Informations Destinataires</h2>
                    <div class="form-group">
                        <label>Choisir la section :</label>
                        <div class="section-buttons" id="convocationSectionButtons"></div>
                    </div>
                    <div class="form-group">
                        <label>Sélectionner les destinataires :</label>
                        <div id="convocationRecipients" class="recipient-list">
                            Sélectionnez une section ci-dessus.
                        </div>
                    </div>
                    <h2>Détails de l'Appel d'Offres</h2>
                    <div class="form-group">
                        <label for="convocationV4">N° Appel d'Offres (V4) :</label>
                        <input type="text" id="convocationV4" placeholder="Ex: 02/2228/CHUSM" required>
                    </div>
                    <div class="form-group">
                        <label for="convocationV5">Objet de l'Appel d'Offres (V5) :</label>
                        <textarea id="convocationV5" rows="3" placeholder="Ex: Acquisition de matériel..." required></textarea>
                    </div>
                    <h2>Date et Heure de la Séance</h2>
                    <div class="form-group">
                        <label for="convocationV6">Date d'ouverture (V6) :</label>
                        <input type="date" id="convocationV6" required>
                    </div>
                    <div class="form-group">
                        <label for="convocationV7">Heure d'ouverture (V7) :</label>
                        <input type="time" id="convocationV7" required>
                    </div>
                    <button type="button" id="generateConvocationPdfButton">Générer les Convocations PDF</button>
                </form>
            </div>

            <!-- Formulaire BORDEREAU V1 -->
            <div id="bordereau-v1-form-wrapper" class="hidden form-container-wrapper">
                <h1>Générateur de Bordereau d'Envoi V1</h1>
                <div class="form-group">
                    <label for="commissionTitleV1">Titre de la commission :</label>
                    <input type="text" id="commissionTitleV1" value="Membres de la commission d'appel d'offres">
                </div>
                <div class="form-group">
                    <label for="offerNumberV1">Numéro de l'appel d'offres :</label>
                    <input type="text" id="offerNumberV1" value="N°01/2024/CHUSM">
                </div>
                <div class="form-group">
                    <label>Membres de la commission :</label>
                    <div class="members-list" id="membersListV1">
                        <div class="member-item"><input type="text" class="member-name" value="Pr. ARRAYHANI Mohamed"><button type="button" class="remove-member">×</button></div>
                        <div class="member-item"><input type="text" class="member-name" value="M. KERBID El Mehdi"><button type="button" class="remove-member">×</button></div>
                        <div class="member-item"><input type="text" class="member-name" value="M. HOUCINE JABBARI"><button type="button" class="remove-member">×</button></div>
                        <div class="member-item"><input type="text" class="member-name" value="Mme. RAMI Rajaa"><button type="button" class="remove-member">×</button></div>
                        <div class="member-item"><input type="text" class="member-name" value="M. OUAYA Laheen"><button type="button" class="remove-member">×</button></div>
                        <div class="member-item"><input type="text" class="member-name" value="M. BELLA Abdoullah"><button type="button" class="remove-member">×</button></div>
                        <div class="member-item"><input type="text" class="member-name" value="M. EL BAAMRANI Said"><button type="button" class="remove-member">×</button></div>
                    </div>
                    <button type="button" class="add-member" id="addMemberV1">Ajouter un membre</button>
                </div>
                <div class="form-group">
                    <label for="offerObjectV1">Objet de l'appel d'offres :</label>
                    <textarea id="offerObjectV1">ACHAT DE LA LITERIE POUR LES BESOINS DE L'INTERNAT RELEVANT DU CENTRE HOSPITALO-UNIVERSITAIRE SOUSS MASSA (Lot Unique)</textarea>
                </div>
                <div class="form-group">
                    <label>Le dossier d'appel d'offres comprend :</label>
                    <div class="pieces-list" id="piecesListV1">
                        <div class="piece-item"><input type="text" class="piece-name" value="CPS"><button type="button" class="remove-piece">×</button></div>
                        <div class="piece-item"><input type="text" class="piece-name" value="Le bordereau des prix détail estimatif"><button type="button" class="remove-piece">×</button></div>
                        <div class="piece-item"><input type="text" class="piece-name" value="Règlement de la consultation"><button type="button" class="remove-piece">×</button></div>
                        <div class="piece-item"><input type="text" class="piece-name" value="Estimation"><button type="button" class="remove-piece">×</button></div>
                        <div class="piece-item"><input type="text" class="piece-name" value="Modèle Acte d'Engagement"><button type="button" class="remove-piece">×</button></div>
                        <div class="piece-item"><input type="text" class="piece-name" value="Modèle Déclaration sur l'Honneur"><button type="button" class="remove-piece">×</button></div>
                        <div class="piece-item"><input type="text" class="piece-name" value="Avis d'appel d'offres (Arabe, Français)"><button type="button" class="remove-piece">×</button></div>
                    </div>
                    <button type="button" class="add-piece" id="addPieceV1">Ajouter une pièce</button>
                </div>
                <button id="generateBordereauV1Pdf">Générer et Télécharger le PDF V1</button>
                <!-- Zone de rendu PDF pour Bordereau V1 -->
                <div id="pdf-render-area-v1" class="pdf-render-area">
                    <div id="bordereau-content-v1" class="bordereau-content-pdf">
                        <div class="header-pdf">
                            <img src="https://static.wixstatic.com/media/54eb1f_99f7a17eea9e4456a26645e79509a76d~mv2.png/v1/fill/w_1429,h_176,al_c,lg_1,q_85,enc_avif,quality_auto/54eb1f_99f7a17eea9e4456a26645e79509a76d~mv2.png" alt="Logo en-tête">
                            <p><strong>AUX</strong></p>
                            <p><strong id="pdf-commission-title-v1"></strong></p>
                            <p><strong id="pdf-numero-ao-header-v1"></strong></p><br>
                            <p><strong>BORDEREAU D'ENVOI</strong></p>
                        </div>
                        <table>
                            <thead><tr><th class="designations">DESIGNATIONS</th><th class="nbre">NBRE</th><th class="observations">OBSERVATIONS</th></tr></thead>
                            <tbody>
                                <tr>
                                    <td class="designations">
                                        <p><strong>Les membres de la commission :</strong></p>
                                        <pre id="pdf-membres-v1"></pre>
                                        <br>
                                        <p><strong>Dossier de l'appel d'offres <span id="pdf-numero-ao-body-v1"></span> comprenant :</strong></p>
                                        <ul id="pdf-pieces-v1"></ul>
                                    </td>
                                    <td class="nbre">Un exemplaire de chaque document</td>
                                    <td class="observations">
                                        <p style="text-align: justify; margin: 0;">
                                            Vous est transmis par voie électronique le Dossier d'appel d'Offres <strong id="pdf-numero-ao-obs-v1"></strong> relatif à : « <strong id="pdf-objet-ao-v1"></strong> », en application du l'alinéa e paragraphe 1 de l'article 20 et de l'alinéa 1 paragraphe 2 de l'article 22 du Décret n° 2-22-431 du 15 chaabane 1444 (8 mars 2023) relatif aux marchés publics, en vous rappelant qu'aux termes de l'articles 22 vous disposez de <strong>6 jours</strong> pour nous faire parvenir vos observations.
                                        </p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="footer-pdf">
                            <img src="https://static.wixstatic.com/media/54eb1f_9d983c91a6c34ea1b871e7a357691871~mv2.png/v1/fill/w_1480,h_152,al_c,lg_1,q_85,enc_avif,quality_auto/54eb1f_9d983c91a6c34ea1b871e7a357691871~mv2.png" alt="Logo pied de page">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formulaire BORDEREAU FINAL -->
            <div id="bordereau-final-form-wrapper" class="hidden form-container-wrapper">
                <h1>Générateur de Bordereau d'Envoi Final</h1>
                 <div class="form-group">
                    <label for="commissionTitleFinal">Titre de la commission :</label>
                    <input type="text" id="commissionTitleFinal" value="Membres de la commission d'appel d'offres">
                </div>
                <div class="form-group">
                    <label for="offerNumberFinal">Numéro de l'appel d'offres :</label>
                    <input type="text" id="offerNumberFinal" value="N°01/2024/CHUSM">
                </div>
                <div class="form-group">
                    <label>Membres de la commission :</label>
                    <div class="members-list" id="membersListFinal">
                        <div class="member-item"><input type="text" class="member-name" value="Pr. ARRAYHANI Mohamed"><button type="button" class="remove-member">×</button></div>
                        <div class="member-item"><input type="text" class="member-name" value="M. KERBID El Mehdi"><button type="button" class="remove-member">×</button></div>
                        <div class="member-item"><input type="text" class="member-name" value="M. HOUCINE JABBARI"><button type="button" class="remove-member">×</button></div>
                        <div class="member-item"><input type="text" class="member-name" value="Mme. RAMI Rajaa"><button type="button" class="remove-member">×</button></div>
                        <div class="member-item"><input type="text" class="member-name" value="M. OUAYA Laheen"><button type="button" class="remove-member">×</button></div>
                        <div class="member-item"><input type="text" class="member-name" value="M. BELLA Abdoullah"><button type="button" class="remove-member">×</button></div>
                        <div class="member-item"><input type="text" class="member-name" value="M. EL BAAMRANI Said"><button type="button" class="remove-member">×</button></div>
                    </div>
                    <button type="button" class="add-member" id="addMemberFinal">Ajouter un membre</button>
                </div>
                <div class="form-group">
                    <label for="offerObjectFinal">Objet de l'appel d'offres :</label>
                    <textarea id="offerObjectFinal">ACHAT DE LA LITERIE POUR LES BESOINS DE L'INTERNAT RELEVANT DU CENTRE HOSPITALO-UNIVERSITAIRE SOUSS MASSA (Lot Unique)</textarea>
                </div>
                <div class="form-group">
                    <label>Le dossier d'appel d'offres comprend :</label>
                    <div class="pieces-list" id="piecesListFinal">
                         <div class="piece-item"><input type="text" class="piece-name" value="CPS"><button type="button" class="remove-piece">×</button></div>
                        <div class="piece-item"><input type="text" class="piece-name" value="Le bordereau des prix détail estimatif"><button type="button" class="remove-piece">×</button></div>
                        <div class="piece-item"><input type="text" class="piece-name" value="Règlement de la consultation"><button type="button" class="remove-piece">×</button></div>
                        <div class="piece-item"><input type="text" class="piece-name" value="Estimation"><button type="button" class="remove-piece">×</button></div>
                        <div class="piece-item"><input type="text" class="piece-name" value="Modèle Acte d'Engagement"><button type="button" class="remove-piece">×</button></div>
                        <div class="piece-item"><input type="text" class="piece-name" value="Modèle Déclaration sur l'Honneur"><button type="button" class="remove-piece">×</button></div>
                        <div class="piece-item"><input type="text" class="piece-name" value="Avis d'appel d'offres (Arabe, Français)"><button type="button" class="remove-piece">×</button></div>
                        <div class="piece-item"><input type="text" class="piece-name" value="Convocation"><button type="button" class="remove-piece">×</button></div>
                    </div>
                    <button type="button" class="add-piece" id="addPieceFinal">Ajouter une pièce</button>
                </div>
                <button id="generateBordereauFinalPdf">Générer et Télécharger le PDF Final</button>
                <!-- Zone de rendu PDF pour Bordereau Final -->
                <div id="pdf-render-area-final" class="pdf-render-area">
                    <div id="bordereau-content-final" class="bordereau-content-pdf">
                        <div class="header-pdf">
                            <img src="https://static.wixstatic.com/media/54eb1f_99f7a17eea9e4456a26645e79509a76d~mv2.png/v1/fill/w_1429,h_176,al_c,lg_1,q_85,enc_avif,quality_auto/54eb1f_99f7a17eea9e4456a26645e79509a76d~mv2.png" alt="Logo en-tête">
                            <p><strong>AUX</strong></p>
                            <p><strong id="pdf-commission-title-final"></strong></p>
                            <p><strong id="pdf-numero-ao-header-final"></strong></p><br>
                            <p><strong>BORDEREAU D'ENVOI</strong></p>
                        </div>
                        <table>
                            <thead><tr><th class="designations">DESIGNATIONS</th><th class="nbre">NBRE</th><th class="observations">OBSERVATIONS</th></tr></thead>
                            <tbody>
                                <tr>
                                    <td class="designations">
                                        <p><strong>Les membres de la commission :</strong></p>
                                        <pre id="pdf-membres-final"></pre>
                                        <br>
                                        <p><strong>Dossier de l'appel d'offres <span id="pdf-numero-ao-body-final"></span> comprenant :</strong></p>
                                        <ul id="pdf-pieces-final"></ul>
                                    </td>
                                    <td class="nbre">Un exemplaire de chaque document</td>
                                    <td class="observations">
                                        <p style="text-align: justify; margin: 0;">
                                           Vous est transmis par voie électronique la version définitive du dossier d'appel d'Offres <strong id="pdf-numero-ao-obs-final"></strong> relatif à : « <strong id="pdf-objet-ao-final"></strong> ».
                                        </p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                         <div class="footer-pdf">
                            <img src="https://static.wixstatic.com/media/54eb1f_9d983c91a6c34ea1b871e7a357691871~mv2.png/v1/fill/w_1480,h_152,al_c,lg_1,q_85,enc_avif,quality_auto/54eb1f_9d983c91a6c34ea1b871e7a357691871~mv2.png" alt="Logo pied de page">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formulaire DECISION -->
            <div id="decision-form-wrapper" class="hidden form-container-wrapper">
                 <h1>Générateur de Décision de Nomination</h1>
                <div class="form-group">
                    <label for="decisionTenderNumber">Numéro d'appel d'offres :</label>
                    <input type="text" id="decisionTenderNumber" placeholder="Ex: 02/2025/CHUSM">
                </div>
                <div class="form-group">
                    <label>Type d'appel d'offres :</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="decisionNational" name="decisionTenderType" value="national" checked>
                            <label for="decisionNational">National</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="decisionInternational" name="decisionTenderType" value="international">
                            <label for="decisionInternational">International</label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="decisionTenderObject">Objet de l'appel d'offres :</label>
                    <textarea id="decisionTenderObject" placeholder="Ex: ACHAT DE MEDICAMENTS..."></textarea>
                </div>
                <div class="form-group">
                    <label>Président :</label>
                    <div class="member-item">
                        <select id="decisionPresident">
                            <option value="Pr. ARRAYHANI Mohamed : Directeur du Centre Hospitalo-Universitaire Souss-Massa">Pr. ARRAYHANI Mohamed : Directeur du Centre Hospitalo-Universitaire Souss-Massa</option>
                        </select>
                    </div>
                    <label>Suppleant :</label>
                    <div class="member-item">
                        <select id="decisionSuppleant">
                            <option value="M. KERBID El Mehdi : Secrétaire Général du CHU Souss-Massa">M. KERBID El Mehdi : Secrétaire Général du CHU Souss-Massa</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Membres :</label>
                    <div class="members-container" id="decisionMembersContainer">
                        <!-- Les membres seront ajoutés ici par JS -->
                    </div>
                    <button class="add-member" id="decisionAddMemberBtn">Ajouter un membre</button>
                </div>
                <button id="decisionGenerateBtn">Générer et Télécharger la Décision PDF</button>
            </div>

            <!-- Formulaire DEMANDE COMPLEMENT -->
            <div id="complement-form-wrapper" class="hidden form-container-wrapper">
                <h1>Générateur de Demandes de Complément</h1>
                <div class="mode-selector">
                    <button id="multiLotBtn" class="mode-btn active">
                       <i class="fas fa-copy mr-2"></i> DEMANDE DE COMPLEMENT-ALLOTI
                    </button>
                    <button id="singleLotBtn" class="mode-btn">
                        <i class="fas fa-file-alt mr-2"></i> DEMANDE DE COMPLEMENT-LOT UNIQUE
                    </button>
                </div>

                <!-- Multi-lot Section -->
                <div id="multiLotSection">
                    <div class="form-section">
                        <h2 class="section-title"><i class="fas fa-info-circle mr-2"></i>Informations sur l'Appel d'Offres</h2>
                        <div class="form-group">
                            <label for="refNumber">N° d'appel d'offres :</label>
                            <input type="text" id="refNumber" class="form-control" value="02/2025/CHUSM">
                        </div>
                        <div class="form-group">
                            <label for="offerType">Type d'appel d'offres :</label>
                            <select id="offerType" class="form-control">
                                <option value="national">National</option>
                                <option value="international" selected>International</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="offerObject">Objet de l'appel d'offres :</label>
                            <textarea id="offerObject" class="form-control">ACHAT DE MÉDICAMENTS POUR LE CENTRE HOSPITALO-UNIVERSITAIRE SOUSS MASSA (220 LOTS)</textarea>
                        </div>
                    </div>

                    <div class="form-section">
                        <h2 class="section-title"><i class="fas fa-building mr-2"></i>Sociétés à Notifier</h2>
                        <table id="societesTable">
                            <thead>
                                <tr>
                                    <th style="width: 18%;">Nom Société</th>
                                    <th style="width: 15%;">Lots Concernés</th>
                                    <th style="width: 55%;">Conditions à Compléter</th>
                                    <th style="width: 10%;">NB facultatif</th>
                                    <th style="width: 2%;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="societesTableBody"></tbody>
                        </table>
                        <button id="addSocieteBtn" type="button" class="btn" style="margin-top: 20px;">
                            <i class="fas fa-plus mr-2"></i> Ajouter une société
                        </button>
                    </div>

                    <div class="action-buttons">
                        <button id="generateMultiBtn" class="btn" style="background-color: rgba(76, 201, 240, 0.7);">
                            <i class="fas fa-file-pdf mr-2"></i> Générer le PDF pour toutes les sociétés
                        </button>
                    </div>
                    <div id="statusMulti" class="text-center mt-4"></div>
                </div>

                <!-- Single-lot Section -->
                <div id="singleLotSection" class="hidden">
                    <div class="form-section">
                        <h2 class="section-title"><i class="fas fa-info-circle mr-2"></i> Informations de base</h2>
                        <div class="form-group">
                            <label for="singleCompanyName"><i class="fas fa-building mr-2"></i> Nom de la société :</label>
                            <input type="text" id="singleCompanyName" class="form-control" placeholder="Ex: STEPLUS">
                        </div>
                        <div class="form-group">
                            <label for="singleRefNumber">Numéro d'appel d'offres :</label>
                            <input type="text" id="singleRefNumber" class="form-control" placeholder="Ex: 29/2024/CHUSM">
                        </div>
                        <div class="form-group">
                            <label for="singleOfferType">Type d'appel d'offres :</label>
                            <select id="singleOfferType" class="form-control">
                                <option value="national">National</option>
                                <option value="international" selected>International</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="pricingType">Type de marché :</label>
                            <select id="pricingType" class="form-control">
                                <option value="sur offres de prix">Sur offres de prix</option>
                                <option value="à majoration">À majoration</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="singleOfferObject">Objet de l'appel d'offres :</label>
                            <textarea id="singleOfferObject" class="form-control" placeholder="Ex: ACHAT DES PRODUITS ET CONSOMMABLES DE STERILISATION..."></textarea>
                        </div>
                    </div>

                    <div class="form-section">
                        <h2 class="section-title"><i class="fas fa-tasks mr-2"></i> Conditions à compléter</h2>
                        <div id="singleConditionsContainer" class="condition-container">
                            <div class="condition-item">
                                <input type="text" class="form-control condition-input" value="Compléter le dossier Administratif conformément à l'article N°05 du règlement de consultation.">
                                <button type="button" class="btn btn-danger btn-sm remove-condition">
                                   <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="condition-item">
                                <input type="text" class="form-control condition-input" value="Produire les échantillons et la liste de colisage cachetés et portant le N° d'appel d'offres accompagnés d'une copie certifiée conforme à l'originale du certificat d'enregistrement des dispositifs médicaux (CEDM) ou de négativité.">
                                <button type="button" class="btn btn-danger btn-sm remove-condition">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" id="addConditionBtn" class="btn">
                            <i class="fas fa-plus mr-2"></i> Ajouter une autre condition
                        </button>
                    </div>

                    <div class="form-section">
                        <h2 class="section-title"><i class="fas fa-sticky-note mr-2"></i> Note complémentaire (facultative)</h2>
                        <textarea id="singleNote" class="form-control" placeholder="Ex: Les échantillons doivent être déposés à..."></textarea>
                    </div>

                    <div class="action-buttons">
                        <button id="generateSingleBtn" class="btn" style="background-color: rgba(76, 201, 240, 0.7);">
                            <i class="fas fa-file-pdf mr-2"></i> Générer et Télécharger le PDF
                        </button>
                    </div>
                    <div id="statusSingle" class="text-center mt-4"></div>
                </div>
            </div>

        </div>

        <!-- Modal pour le message temporaire -->
        <div id="temp-message-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 hidden z-50 backdrop-blur-sm">
            <div class="glass-card p-8 max-w-md w-full transform transition-all rounded-2xl">
                <div class="text-center">
                    <div class="bg-yellow-500/20 p-4 rounded-full inline-flex mb-4">
                        <i class="fas fa-exclamation-triangle text-yellow-400 text-3xl"></i>
                    </div>
                    <h3 class="text-2xl font-semibold text-white mb-2">En cours de développement</h3>
                    <p class="text-white/80 mb-6">Cette fonctionnalité sera disponible prochainement.</p>
                    <div class="w-full bg-white/20 rounded-full h-2 mb-6">
                        <div id="progress-bar" class="bg-white h-2 rounded-full" style="width: 100%"></div>
                    </div>
                    <button onclick="closeTempMessage()" class="modern-btn px-6 py-2 rounded-xl bg-white/20 hover:bg-white/30 text-white">
                        Fermer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Particules flottantes en arrière-plan -->
    <div id="particles-js" class="fixed inset-0 pointer-events-none z-[-1]"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>

    <script>
        // Make jsPDF globally available
        window.jsPDF = window.jspdf.jsPDF;

        // --- Initialisation des particules ---
        document.addEventListener('DOMContentLoaded', function() {
            if (document.getElementById('particles-js')) {
                particlesJS('particles-js', { /* configuration particles.js (inchangée) */
                    "particles":{ "number":{"value":50,"density":{"enable":true,"value_area":800}},"color":{"value":"#ffffff"},"shape":{"type":"circle","stroke":{"width":0,"color":"#000000"},"polygon":{"nb_sides":5}},"opacity":{"value":0.5,"random":true,"anim":{"enable":true,"speed":1,"opacity_min":0.1,"sync":false}},"size":{"value":3,"random":true,"anim":{"enable":true,"speed":2,"size_min":0.1,"sync":false}},"line_linked":{"enable":true,"distance":150,"color":"#ffffff","opacity":0.4,"width":1},"move":{"enable":true,"speed":1,"direction":"none","random":true,"straight":false,"out_mode":"out","bounce":false,"attract":{"enable":false,"rotateX":600,"rotateY":1200}}},"interactivity":{"detect_on":"canvas","events":{"onhover":{"enable":true,"mode":"grab"},"onclick":{"enable":true,"mode":"push"},"resize":true},"modes":{"grab":{"distance":140,"line_linked":{"opacity":1}},"bubble":{"distance":400,"size":40,"duration":2,"opacity":8,"speed":3},"repulse":{"distance":200,"duration":0.4},"push":{"particles_nb":4},"remove":{"particles_nb":2}}},"retina_detect":true
                });
            }
        });

        // --- Gestion de la connexion et navigation principale ---
        const VALID_PASSWORD = "1111";
        const loginForm = document.getElementById('login-form');
        const loginScreen = document.getElementById('login-screen');
        const mainMenu = document.getElementById('main-menu');
        const formContainersDiv = document.getElementById('form-containers');
        const backToMenuBtn = document.getElementById('backToMenuBtn');

        if (loginForm) {
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const passwordInput = document.getElementById('password');
                const errorMessage = document.getElementById('error-message');
                
                if (passwordInput.value === VALID_PASSWORD) {
                    errorMessage.classList.add('hidden');
                    loginScreen.classList.add('opacity-0', 'pointer-events-none');
                    setTimeout(() => {
                        loginScreen.classList.add('hidden');
                        mainMenu.classList.remove('hidden');
                        mainMenu.classList.add('opacity-100'); // Pas besoin d'animate-fadeIn si déjà géré par tailwind transition
                    }, 500);
                } else {
                    errorMessage.classList.remove('hidden');
                    passwordInput.classList.add('border-red-500'); // Tailwind class pour bordure rouge
                    setTimeout(() => {
                        passwordInput.classList.remove('border-red-500');
                    }, 2000);
                }
            });
        }

        function handleOptionClick(optionNumber) {
            const allFormWrappers = formContainersDiv.querySelectorAll(':scope > div.form-container-wrapper');
            allFormWrappers.forEach(div => div.classList.add('hidden'));

            if (optionNumber === 5) { 
                mainMenu.classList.add('hidden');
                formContainersDiv.classList.remove('hidden');
                backToMenuBtn.classList.remove('hidden');
                document.getElementById('complement-form-wrapper').classList.remove('hidden');
                initializeComplementForm();
            } else {
                mainMenu.classList.add('hidden');
                formContainersDiv.classList.remove('hidden');
                backToMenuBtn.classList.remove('hidden');

                let targetWrapperId = '';
                switch(optionNumber) {
                    case 1: targetWrapperId = 'convocation-form-wrapper'; initializeConvocationForm(); break;
                    case 2: targetWrapperId = 'bordereau-v1-form-wrapper'; initializeBordereauV1Form(); break;
                    case 3: targetWrapperId = 'bordereau-final-form-wrapper'; initializeBordereauFinalForm(); break;
                    case 4: targetWrapperId = 'decision-form-wrapper'; initializeDecisionForm(); break;
                }
                if (targetWrapperId) {
                    document.getElementById(targetWrapperId).classList.remove('hidden');
                }
            }
        }
        
        function showTempMessage() {
            const modal = document.getElementById('temp-message-modal');
            const progressBar = document.getElementById('progress-bar');
            modal.classList.remove('hidden');
            let width = 100;
            const interval = setInterval(() => {
                width -= (100 / (50 * 2)); // Ajuster pour une durée de 2.5s (50 * 50ms = 2.5s)
                progressBar.style.width = width + '%';
                if (width <= 0) {
                    clearInterval(interval);
                    closeTempMessage();
                }
            }, 50);
        }
        
        function closeTempMessage() {
            document.getElementById('temp-message-modal').classList.add('hidden');
            document.getElementById('progress-bar').style.width = '100%';
        }
        
        if (backToMenuBtn) {
            backToMenuBtn.addEventListener('click', () => {
                formContainersDiv.classList.add('hidden');
                mainMenu.classList.remove('hidden');
                backToMenuBtn.classList.add('hidden');
            });
        }

        // --- Fonctions d'initialisation et logique pour chaque formulaire ---

        // --- LOGIQUE POUR CONVOCATION ---
        function initializeConvocationForm() {
            const sections = {
                DPI: [ { v1: "M. KERBID El Mehdi", v2: "Secrétaire Général du CHU Souss-Massa", v3: "président de la commission d'appel d'offres", v8: "mkerbid@chusm.ma" }, { v1: "M. BATAAL Ali", v2: "Chef de la division des systèmes d'information au CHU Souss-Massa", v3: "membre de la commission d'appel d'offres", v8: "abataal@chusm.ma" }, { v1: "M. HOUCINE JABBARI", v2: "Contrôleur d'Etat près le CHU Souss-Massa", v3: "membre de la commission d'appel d'offres", v8: "h.jabbari@depp.gov.ma" }, { v1: "Mme. RAMI Rajaa", v2: "Chef de la Division des Affaires Financières au CHU Souss-Massa", v3: "membre de la commission d'appel d'offres", v8: "rrami@chusm.ma" }, { v1: "M. OUAYA Lahcen", v2: "Chef du Service de la commande publique au CHU Souss-Massa", v3: "membre de la commission d'appel d'offres", v8: "louaya@chusm.ma" }, { v1: "M. EL BAAMRANI Said", v2: "Chef du Service du Budget et de la Comptabilité au CHU Souss-Massa", v3: "membre de la commission d'appel d'offres", v8: "selbaamrani@chusm.ma" }, { v1: "M. BELLA Abdoullah", v2: "Chef de la Division des Affaires Administratives et Juridiques au CHU Souss-Massa", v3: "membre de la commission d'appel d'offres", v8: "abella@chusm.ma" } ],
                Pharmacie: [ { v1: "M. KERBID El Mehdi", v2: "Secrétaire Général du CHU Souss-Massa", v3: "président de la commission d'appel d'offres", v8: "mkerbid@chusm.ma" }, { v1: "M. BATAAL Ali", v2: "Chef de la division des systèmes d'information au CHU Souss-Massa", v3: "membre de la commission d'appel d'offres", v8: "abataal@chusm.ma" }, { v1: "M. HOUCINE JABBARI", v2: "Contrôleur d'Etat près le CHU Souss-Massa", v3: "membre de la commission d'appel d'offres", v8: "h.jabbari@depp.gov.ma" }, { v1: "Mme. RAMI Rajaa", v2: "Chef de la Division des Affaires Financières au CHU Souss-Massa", v3: "membre de la commission d'appel d'offres", v8: "rrami@chusm.ma" }, { v1: "M. OUAYA Lahcen", v2: "Chef du Service de la commande publique au CHU Souss-Massa", v3: "membre de la commission d'appel d'offres", v8: "louaya@chusm.ma" }, { v1: "M. EL YOUBI Zouhir", v2: "Chef du Service de la Pharmacie centrale au CHU Souss-Massa", v3: "membre de la commission d'appel d'offres", v8: "zelyoubi@chusm.ma" }, { v1: "Mme. ELMKIESS Zaineb", v2: "Pharmacienne au CHU Souss-Massa", v3: "membre de la commission d'appel d'offres", v8: "zelmkiess@chusm.ma" } ],
                Informatique: [ { v1: "M. KERBID El Mehdi", v2: "Secrétaire Général du CHU Souss-Massa", v3: "président de la commission d'appel d'offres", v8: "mkerbid@chusm.ma" }, { v1: "M. BATAAL Ali", v2: "Chef de la division des systèmes d'information au CHU Souss-Massa", v3: "membre de la commission d'appel d'offres", v8: "abataal@chusm.ma" }, { v1: "M. HOUCINE JABBARI", v2: "Contrôleur d'Etat près le CHU Souss-Massa", v3: "membre de la commission d'appel d'offres", v8: "h.jabbari@depp.gov.ma" }, { v1: "Mme. RAMI Rajaa", v2: "Chef de la Division des Affaires Financières au CHU Souss-Massa", v3: "membre de la commission d'appel d'offres", v8: "rrami@chusm.ma" }, { v1: "M. OUAYA Lahcen", v2: "Chef du Service de la commande publique au CHU Souss-Massa", v3: "membre de la commission d'appel d'offres", v8: "louaya@chusm.ma" }, { v1: "Mme. EZ-ZAYDY Ikrame", v2: "Chef du Service de développement informatique au CHU Souss-Massa", v3: "membre de la commission d'appel d'offres", v8: "iez-zaydy@chusm.ma" }, { v1: "M. MOUSSAFIR Mustafa", v2: "Ingénieur d'Etat 1er Grade au CHU Souss-Massa", v3: "membre de la commission d'appel d'offres", v8: "mmoussafir@chusm.ma" }, { v1: "M. SLIMANI Ilias", v2: "Ingénieur d'Etat 1er Grade au CHU Souss-Massa", v3: "membre de la commission d'appel d'offres", v8: "islimani@chusm.ma" } ]
            };
            const pdfConfigConv = { leftMargin: 20, rightMargin: 20, topMargin: 20, bottomMargin: 30, lineSpacing: 7, paragraphSpacing: 4, fontSize: 11, fontName: 'Cambria' };
            const sectionButtonsDivConv = document.getElementById('convocationSectionButtons');
            const recipientsDivConv = document.getElementById('convocationRecipients');
            const generatePdfButtonConv = document.getElementById('generateConvocationPdfButton');
            let activeSectionButtonConv = null;

            if (sectionButtonsDivConv && !sectionButtonsDivConv.hasChildNodes()) {
                Object.keys(sections).forEach(sectionName => {
                    const button = document.createElement('button');
                    button.type = 'button'; button.textContent = sectionName;
                    button.addEventListener('click', () => displayRecipientsConv(sectionName, button));
                    sectionButtonsDivConv.appendChild(button);
                });
            }
            
            // Détacher les anciens écouteurs avant d'en ajouter de nouveaux pour éviter les duplications
            const newGenerateBtnConv = generatePdfButtonConv.cloneNode(true);
            generatePdfButtonConv.parentNode.replaceChild(newGenerateBtnConv, generatePdfButtonConv);
            newGenerateBtnConv.addEventListener('click', handleGeneratePdfClickConv);


            function formatDateFrConv(dateString) {
                if (!dateString) return '';
                try {
                    const dateObj = new Date(dateString + "T00:00:00"); // Assurer que c'est traité comme date locale
                    if (isNaN(dateObj.getTime())) { return dateString; }
                    return dateObj.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                } catch (e) { return dateString; }
            }
            function formatTimeHmConv(timeString) { return timeString ? timeString.replace(':', 'h') : ''; }
            function sanitizeFilenameConv(name) { return (name || '').replace(/[^a-zA-Z0-9_-]/g, '_').substring(0, 50); }

            function displayRecipientsConv(sectionName, clickedButton) {
                if (activeSectionButtonConv) activeSectionButtonConv.classList.remove('active');
                clickedButton.classList.add('active'); activeSectionButtonConv = clickedButton;
                recipientsDivConv.innerHTML = "";

                if (sections[sectionName] && sections[sectionName].length > 0) {
                    const selectAllDiv = document.createElement('div'); selectAllDiv.className = 'select-all-group';
                    const selectAllInput = document.createElement('input'); selectAllInput.type = 'checkbox'; selectAllInput.id = `conv-select-all-${sectionName}`;
                    selectAllInput.addEventListener('change', function() { toggleSelectAllConv(this, sectionName); });
                    const selectAllLabel = document.createElement('label'); selectAllLabel.htmlFor = selectAllInput.id; selectAllLabel.textContent = ' Tout sélectionner / Désélectionner';
                    selectAllDiv.appendChild(selectAllInput); selectAllDiv.appendChild(selectAllLabel); recipientsDivConv.appendChild(selectAllDiv);

                    sections[sectionName].forEach((recipient, index) => {
                        const cbDiv = document.createElement('div'); cbDiv.className = 'checkbox-group';
                        const input = document.createElement('input'); input.type = 'checkbox'; input.name = 'convRecipient'; input.value = JSON.stringify(recipient); input.id = `conv-recipient-${sanitizeFilenameConv(sectionName)}-${index}`;
                        const label = document.createElement('label'); label.htmlFor = input.id; label.textContent = ` ${recipient.v1 || 'N/A'}`;
                        cbDiv.appendChild(input); cbDiv.appendChild(label); recipientsDivConv.appendChild(cbDiv);
                    });
                } else { recipientsDivConv.textContent = "Aucun destinataire."; }
            }
            function toggleSelectAllConv(selectAllCheckbox, sectionName) {
                const isChecked = selectAllCheckbox.checked;
                recipientsDivConv.querySelectorAll('input[name="convRecipient"]').forEach(cb => cb.checked = isChecked);
            }

            function drawSinglePDFPageConv(pdfDoc, recipient, commonData) {
                const { leftMargin, rightMargin, topMargin, lineSpacing, paragraphSpacing, fontSize, fontName } = pdfConfigConv;
                const usableWidth = pdfDoc.internal.pageSize.getWidth() - leftMargin - rightMargin;
                let y = topMargin;

                pdfDoc.setFont(fontName); pdfDoc.setFontSize(fontSize);
                const headerImgUrl = 'https://static.wixstatic.com/media/54eb1f_99f7a17eea9e4456a26645e79509a76d~mv2.png/v1/fill/w_1429,h_176,al_c,lg_1,q_85,enc_avif,quality_auto/54eb1f_99f7a17eea9e4456a26645e79509a76d~mv2.png';
                const imgWidth = 180, imgHeight = 22;
                pdfDoc.addImage(headerImgUrl, 'PNG', (pdfDoc.internal.pageSize.getWidth() - imgWidth) / 2, y - 10, imgWidth, imgHeight);
                y += imgHeight + lineSpacing;

                pdfDoc.setFont(fontName, 'bold');
                pdfDoc.text("A", pdfDoc.internal.pageSize.getWidth() / 2, y, { align: 'center' }); y += lineSpacing;
                pdfDoc.text(recipient.v1 || "N/A", pdfDoc.internal.pageSize.getWidth() / 2, y, { align: 'center' }); y += lineSpacing;
                pdfDoc.setFont(fontName, 'italic');
                pdfDoc.text(recipient.v2 || "N/A", pdfDoc.internal.pageSize.getWidth() / 2, y, { align: 'center' }); y += lineSpacing * 2;
                
                pdfDoc.setFont(fontName, 'bold');
                pdfDoc.text("Objet : Commission d'ouverture des plis", leftMargin, y); y += lineSpacing;
                pdfDoc.setFont(fontName, 'normal');
                pdfDoc.text(`Réf. : Appel d'Offres Ouvert N° ${commonData.v4 || 'N/A'}`, leftMargin, y); y += lineSpacing * 2;

                const body1 = `Conformément à l'article 38 du Décret n° 2-22-431 du 15 Chaabane 1444 (8 mars 2023) relatif aux marchés publics, j'ai l'honneur de vous demander de bien vouloir assister, en tant que ${recipient.v3 || 'membre'}, à la séance d'ouverture des plis de l'appel d'offre ouvert national sur offre de prix N° ${commonData.v4 || 'N/A'} relatif à :`;
                pdfDoc.text(body1, leftMargin, y, { maxWidth: usableWidth, align: 'justify' });
                y += pdfDoc.getTextDimensions(body1, { maxWidth: usableWidth }).h + paragraphSpacing;
                
                pdfDoc.setFont(fontName, 'bold');
                const objetAO = commonData.v5 || 'N/A';
                pdfDoc.text(objetAO, pdfDoc.internal.pageSize.getWidth() / 2, y, { maxWidth: usableWidth, align: 'center' });
                y += pdfDoc.getTextDimensions(objetAO, { maxWidth: usableWidth, align: 'center' }).h + paragraphSpacing;

                pdfDoc.setFont(fontName, 'normal');
                const body2 = `Cette séance aura lieu au siège de la Direction du Centre Hospitalo-Universitaire de Souss-Massa, sis à l'Institut Supérieur des Professions Infirmières et Techniques de Santé (ISPITS) Agadir, le ${formatDateFrConv(commonData.v6)} à ${formatTimeHmConv(commonData.v7)}.`;
                pdfDoc.text(body2, leftMargin, y, { maxWidth: usableWidth, align: 'justify' });
                y += pdfDoc.getTextDimensions(body2, { maxWidth: usableWidth }).h + paragraphSpacing;
                
                pdfDoc.setFont(fontName, 'italic');
                const body3 = `Je porte à votre connaissance que le dossier de l'appel d'Offres vous est transmis par courriel à votre adresse : ${recipient.v8 || 'non spécifiée'}`;
                pdfDoc.text(body3, leftMargin, y, { maxWidth: usableWidth, align: 'justify' });
                y += pdfDoc.getTextDimensions(body3, { maxWidth: usableWidth }).h + lineSpacing * 1.5;

                pdfDoc.setFont(fontName, 'normal');
                const salutation = `Veuillez agréer, ${recipient.v1 && recipient.v1.startsWith('Mme.') ? 'Madame' : 'Monsieur'}, l'expression de mes salutations distinguées.`;
                pdfDoc.text(salutation, leftMargin, y, { maxWidth: usableWidth });
                y += pdfDoc.getTextDimensions(salutation, { maxWidth: usableWidth }).h + lineSpacing * 2;

                const currentDate = new Date().toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                pdfDoc.setFontSize(10);
                pdfDoc.text(`Fait à Agadir, le ${currentDate}`, pdfDoc.internal.pageSize.getWidth() - rightMargin, y, { align: 'right' });

                const footerImgUrl = 'https://static.wixstatic.com/media/54eb1f_9d983c91a6c34ea1b871e7a357691871~mv2.png/v1/fill/w_1480,h_152,al_c,lg_1,q_85,enc_auto/54eb1f_9d983c91a6c34ea1b871e7a357691871~mv2.png';
                const footerImgHeight = 20; // Adjusted height based on visual
                pdfDoc.addImage(footerImgUrl, 'PNG', (pdfDoc.internal.pageSize.getWidth() - imgWidth) / 2, pdfDoc.internal.pageSize.getHeight() - footerImgHeight - (pdfConfigConv.bottomMargin / 2) +5, imgWidth, footerImgHeight);
            }

            async function generateAndDownloadSinglePDFConv(recipient, commonData) {
                const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                drawSinglePDFPageConv(pdf, recipient, commonData);
                pdf.save(`Convocation_${sanitizeFilenameConv(recipient.v1)}_${sanitizeFilenameConv(commonData.v4)}.pdf`);
            }
            async function generateCombinedPDFConv(selectedCheckboxes, commonData) {
                const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                selectedCheckboxes.forEach((cb, index) => {
                    if (index > 0) pdf.addPage();
                    drawSinglePDFPageConv(pdf, JSON.parse(cb.value), commonData);
                });
                pdf.save(`Convocations_Multiples_${sanitizeFilenameConv(commonData.v4)}.pdf`);
            }

            async function handleGeneratePdfClickConv() {
                const btn = document.getElementById('generateConvocationPdfButton');
                const selectedCBs = recipientsDivConv.querySelectorAll('input[name="convRecipient"]:checked');
                const commonData = {
                    v4: document.getElementById('convocationV4').value, v5: document.getElementById('convocationV5').value,
                    v6: document.getElementById('convocationV6').value, v7: document.getElementById('convocationV7').value
                };
                if (selectedCBs.length === 0) { alert("Sélectionnez destinataire(s)."); return; }
                if (!commonData.v4 || !commonData.v5 || !commonData.v6 || !commonData.v7) { alert("Remplissez les détails AO."); return; }
                
                btn.disabled = true; btn.textContent = 'Génération...';
                try {
                    if (selectedCBs.length === 1) await generateAndDownloadSinglePDFConv(JSON.parse(selectedCBs[0].value), commonData);
                    else await generateCombinedPDFConv(Array.from(selectedCBs), commonData);
                    alert(`${selectedCBs.length} convocation(s) générée(s)!`);
                } catch (err) { alert(`Erreur: ${err.message}`); console.error(err); }
                finally { btn.disabled = false; btn.textContent = 'Générer les Convocations PDF'; }
            }
             // Auto-select first section if available
            if (sectionButtonsDivConv && sectionButtonsDivConv.firstChild && typeof sectionButtonsDivConv.firstChild.click === 'function') {
                sectionButtonsDivConv.firstChild.click();
            }
        }

        // --- LOGIQUE POUR BORDEREAU (V1 et Final) ---
        // Helper function for Bordereau PDF generation (V1 and Final)
        function setupBordereauLogic(type) { // type can be 'V1' or 'Final'
            const wrapperId = `bordereau-${type.toLowerCase()}-form-wrapper`;
            const formWrapper = document.getElementById(wrapperId);
            if (!formWrapper) return;

            const membersList = formWrapper.querySelector(`#membersList${type}`);
            const piecesList = formWrapper.querySelector(`#piecesList${type}`);
            const addMemberButton = formWrapper.querySelector(`#addMember${type}`);
            const addPieceButton = formWrapper.querySelector(`#addPiece${type}`);
            const generatePdfButton = formWrapper.querySelector(`#generateBordereau${type}Pdf`);

            function addDynamicRemoveListener(button, itemClass) {
                button.addEventListener('click', function() {
                    this.closest(itemClass).remove();
                });
            }

            addMemberButton.onclick = () => { // Use onclick to override previous if any
                const memberItem = document.createElement('div');
                memberItem.className = 'member-item';
                memberItem.innerHTML = `<input type="text" class="member-name" placeholder="Nom du membre"><button type="button" class="remove-member">×</button>`;
                membersList.appendChild(memberItem);
                addDynamicRemoveListener(memberItem.querySelector('.remove-member'), '.member-item');
            };

            addPieceButton.onclick = () => { // Use onclick to override previous if any
                const pieceItem = document.createElement('div');
                pieceItem.className = 'piece-item';
                pieceItem.innerHTML = `<input type="text" class="piece-name" placeholder="Nom de la pièce"><button type="button" class="remove-piece">×</button>`;
                piecesList.appendChild(pieceItem);
                addDynamicRemoveListener(pieceItem.querySelector('.remove-piece'), '.piece-item');
            };
            
            // Initial remove listeners
            membersList.querySelectorAll('.remove-member').forEach(btn => addDynamicRemoveListener(btn, '.member-item'));
            piecesList.querySelectorAll('.remove-piece').forEach(btn => addDynamicRemoveListener(btn, '.piece-item'));


            generatePdfButton.onclick = function() { // Use onclick to override previous if any
                console.log(`Génération PDF Bordereau ${type} démarrée...`);
                this.textContent = "Génération en cours...";
                this.disabled = true;

                const commissionTitle = formWrapper.querySelector(`#commissionTitle${type}`).value;
                const offerNumber = formWrapper.querySelector(`#offerNumber${type}`).value;
                const offerObject = formWrapper.querySelector(`#offerObject${type}`).value;
                const memberNames = Array.from(membersList.querySelectorAll('.member-name')).map(input => input.value.trim()).filter(name => name);
                const pieceNames = Array.from(piecesList.querySelectorAll('.piece-name')).map(input => input.value.trim()).filter(name => name);

                const pdfContentDiv = formWrapper.querySelector(`#bordereau-content-${type.toLowerCase()}`);
                pdfContentDiv.querySelector(`#pdf-commission-title-${type.toLowerCase()}`).textContent = commissionTitle;
                pdfContentDiv.querySelector(`#pdf-numero-ao-header-${type.toLowerCase()}`).textContent = offerNumber;
                pdfContentDiv.querySelector(`#pdf-numero-ao-body-${type.toLowerCase()}`).textContent = offerNumber;
                pdfContentDiv.querySelector(`#pdf-numero-ao-obs-${type.toLowerCase()}`).textContent = offerNumber;
                pdfContentDiv.querySelector(`#pdf-objet-ao-${type.toLowerCase()}`).textContent = offerObject;
                pdfContentDiv.querySelector(`#pdf-membres-${type.toLowerCase()}`).textContent = memberNames.map(name => `- ${name}`).join('\n');
                
                const pdfPiecesUl = pdfContentDiv.querySelector(`#pdf-pieces-${type.toLowerCase()}`);
                pdfPiecesUl.innerHTML = '';
                pieceNames.forEach(name => {
                    const li = document.createElement('li');
                    li.textContent = `${name} ;`;
                    pdfPiecesUl.appendChild(li);
                });

                html2canvas(pdfContentDiv, { scale: 2, useCORS: true, windowHeight: pdfContentDiv.scrollHeight, scrollY: -window.scrollY })
                    .then(canvas => {
                        const imgData = canvas.toDataURL('image/png');
                        const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        const pdfHeight = pdf.internal.pageSize.getHeight();
                        const imgRatio = canvas.width / canvas.height;
                        
                        let finalWidth = pdfWidth;
                        let finalHeight = finalWidth / imgRatio;
                        if (finalHeight > pdfHeight) {
                            finalHeight = pdfHeight;
                            finalWidth = finalHeight * imgRatio;
                        }
                        const posX = (pdfWidth - finalWidth) / 2;
                        const posY = 0; // Align to top

                        pdf.addImage(imgData, 'PNG', posX, posY, finalWidth, finalHeight);
                        const safeOfferNumber = offerNumber.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                        pdf.save(`bordereau_envoi_${type.toLowerCase()}_${safeOfferNumber}.pdf`);
                    })
                    .catch(err => {
                        console.error(`Erreur html2canvas Bordereau ${type}:`, err);
                        alert(`Erreur capture PDF Bordereau ${type}.`);
                    })
                    .finally(() => {
                        this.textContent = `Générer et Télécharger le PDF ${type}`;
                        this.disabled = false;
                    });
            };
        }

        function initializeBordereauV1Form() {
            setupBordereauLogic('V1');
        }
        function initializeBordereauFinalForm() {
            setupBordereauLogic('Final');
        }


        // --- LOGIQUE POUR DECISION ---
        function initializeDecisionForm() {
            const wrapper = document.getElementById('decision-form-wrapper');
            if (!wrapper) return;

            const predefinedMembers = [
                "Mme. RAMI Rajaa : Chef de la Division des Affaires Financières au CHU Souss-Massa",
                "M. OUAYA Laheen : Chef du Service de la commande publique au CHU Souss-Massa",
                "M. EL YOUBI Zouhir : Chef du Service de la Pharmacie centrale au centre hospitalo-universitaire Souss-Massa",
                "Mme. EL MKiESS Zajueb : Pharmacienne au Centre Hospitalo-Universitaire Souss Massa"
            ];
            const membersContainer = wrapper.querySelector('#decisionMembersContainer');
            const addMemberBtn = wrapper.querySelector('#decisionAddMemberBtn');
            const generateBtn = wrapper.querySelector('#decisionGenerateBtn');

            // Clear existing members before adding, to prevent duplication if init is called multiple times
            membersContainer.innerHTML = ''; 
            predefinedMembers.forEach(member => addDecisionMember(member));

            addMemberBtn.onclick = () => addDecisionMember(); // Use onclick to ensure only one listener
            generateBtn.onclick = generateDecisionPDF; // Use onclick

            function addDecisionMember(initialValue = "") {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'member-item';
                const select = document.createElement('select');
                predefinedMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member; option.textContent = member;
                    select.appendChild(option);
                });
                const customOption = document.createElement('option');
                customOption.value = ""; customOption.textContent = "-- Ajouter un nouveau membre --";
                select.appendChild(customOption);
                if (initialValue) select.value = initialValue;

                const input = document.createElement('input');
                input.type = 'text'; input.placeholder = 'Nom et qualité du membre';
                input.style.display = initialValue ? 'none' : (select.value === "" ? 'block' : 'none');
                if (initialValue && !predefinedMembers.includes(initialValue)) { // Custom initial value
                     select.value = ""; input.style.display = 'block'; input.value = initialValue;
                     select.style.display = 'none';
                } else {
                     select.style.display = initialValue ? 'block' : (select.value === "" ? 'none' : 'block');
                }


                const removeBtn = document.createElement('button');
                removeBtn.textContent = '×'; removeBtn.className = 'remove-member';
                removeBtn.onclick = () => membersContainer.removeChild(memberDiv);

                select.onchange = function() {
                    if (this.value === "") {
                        this.style.display = 'none'; input.style.display = 'block'; input.focus();
                    } else {
                        this.style.display = 'block'; input.style.display = 'none';
                    }
                };
                memberDiv.appendChild(select); memberDiv.appendChild(input); memberDiv.appendChild(removeBtn);
                membersContainer.appendChild(memberDiv);
            }

            function generateDecisionPDF() {
                const tenderNumber = wrapper.querySelector('#decisionTenderNumber').value;
                const tenderType = wrapper.querySelector('input[name="decisionTenderType"]:checked').value;
                const tenderObject = wrapper.querySelector('#decisionTenderObject').value;
                const president = wrapper.querySelector('#decisionPresident').value;
                const suppleant = wrapper.querySelector('#decisionSuppleant').value;
                const members = [];
                wrapper.querySelectorAll('#decisionMembersContainer .member-item').forEach(item => {
                    const select = item.querySelector('select');
                    const input = item.querySelector('input[type="text"]');
                    if (select.style.display !== 'none' && select.value) members.push(select.value);
                    else if (input.style.display !== 'none' && input.value) members.push(input.value);
                });

                if (!tenderNumber || !tenderObject) {
                    alert("Veuillez remplir le numéro et l'objet de l'appel d'offres.");
                    return;
                }

                const doc = new jsPDF();
                const headerImgSrc = 'https://static.wixstatic.com/media/54eb1f_99f7a17eea9e4456a26645e79509a76d~mv2.png/v1/fill/w_1429,h_176,al_c,lg_1,q_85,enc_auto/54eb1f_99f7a17eea9e4456a26645e79509a76d~mv2.png';
                doc.addImage(headerImgSrc, 'PNG', 10, 10, 190, 22);
                doc.setFont('helvetica', 'normal');
                let yPos = 45;

                doc.setFontSize(16); doc.text('DECISION', 105, yPos, { align: 'center' }); yPos += 10;
                doc.setFontSize(14);
                doc.text('PORTANT NOMINATION DES MEMBRES', 105, yPos, { align: 'center' }); yPos += 6;
                doc.text('DE LA COMMISSION DE L\'APPEL D\'OFFRES ' + (tenderType === 'international' ? 'OUVERT INTERNATIONAL' : 'NATIONAL') + ' SUR OFFRES', 105, yPos, { align: 'center' }); yPos += 6;
                doc.text('DES PRIX', 105, yPos, { align: 'center' }); yPos += 6;
                doc.text(tenderNumber, 105, yPos, { align: 'center' }); yPos += 12;

                doc.setFontSize(12); doc.text('LE DIRECTEUR DU CENTRE HOSPITALO-UNIVERSITAIRE SOUSS-MASSA', 105, yPos, { align: 'center' }); yPos += 10;
                doc.setFontSize(10); doc.text('Vu le Décret n° 2-22-431 du 15 chaabane 1444 (8 mars 2023) relatif aux marchés publics.', 15, yPos); yPos += 10;
                doc.setFontSize(12); doc.text('DECIDE', 105, yPos, { align: 'center' }); yPos += 10;
                doc.text('ARTICLE UNIQUE :', 15, yPos); yPos += 10;

                const mainText = [
                    `En plus du représentant du ministre chargé des finances, la commission d'appel d'offres`,
                    `chargée d'examiner les offres relatives à l'appel d'offres ${tenderType === 'international' ? 'ouvert international' : 'national'} sur offres`,
                    `${tenderNumber} relatif à :`
                ];
                mainText.forEach(line => { doc.text(line, 15, yPos); yPos += 7; });
                
                const tenderObjectLines = doc.splitTextToSize(tenderObject, 180);
                doc.setFont('helvetica', 'bold');
                tenderObjectLines.forEach(line => { doc.text(line, 15, yPos); yPos += 7; });
                doc.setFont('helvetica', 'normal'); yPos += 7;
                doc.text('Est composée comme suit :', 15, yPos); yPos += 10;

                doc.setFont('helvetica', 'bold'); doc.text('PRESIDENT :', 15, yPos); yPos += 7;
                doc.setFont('helvetica', 'normal'); doc.text('- ' + president, 20, yPos); yPos += 10;

                doc.setFont('helvetica', 'bold'); doc.text('En cas d\'absence ou empêchement du président, la suppléance sera assurée par :', 15, yPos); yPos += 7;
                doc.setFont('helvetica', 'normal'); doc.text('- ' + suppleant, 20, yPos); yPos += 10;

                doc.setFont('helvetica', 'bold'); doc.text('MEMBRES :', 15, yPos);
                doc.setFont('helvetica', 'normal');
                members.forEach(member => { yPos += 7; doc.text('- ' + member, 20, yPos); });
                yPos += 15;

                doc.text('Il s\'adjoint à la commission d\'ouverture des plis à titre consultatif toute autre personne dont', 15, yPos); yPos += 7;
                doc.text('la présence est jugée utile pour l\'accomplissement de sa mission.', 15, yPos);

                const footerImgSrc = 'https://static.wixstatic.com/media/54eb1f_9d983c91a6c34ea1b871e7a357691871~mv2.png/v1/fill/w_1480,h_152,al_c,lg_1,q_85,enc_auto/54eb1f_9d983c91a6c34ea1b871e7a357691871~mv2.png';
                const footerHeight = 15;
                doc.addImage(footerImgSrc, 'PNG', 10, doc.internal.pageSize.getHeight() - footerHeight - 10, 190, footerHeight);
                doc.save(`Decision_Nomination_${tenderNumber.replace(/[/\s]/g, '_')}.pdf`);
            }
        }

        // --- LOGIQUE POUR DEMANDE DE COMPLEMENT ---
        function initializeComplementForm() {
            const { jsPDF } = window.jspdf;
            
            // Mode selection
            const multiLotBtn = document.getElementById('multiLotBtn');
            const singleLotBtn = document.getElementById('singleLotBtn');
            const multiLotSection = document.getElementById('multiLotSection');
            const singleLotSection = document.getElementById('singleLotSection');
            
            // Multi-lot elements
            const addSocieteBtn = document.getElementById('addSocieteBtn');
            const generateMultiBtn = document.getElementById('generateMultiBtn');
            const societesTableBody = document.getElementById('societesTableBody');
            const statusMultiDiv = document.getElementById('statusMulti');
            
            // Single-lot elements
            const addConditionBtn = document.getElementById('addConditionBtn');
            const generateSingleBtn = document.getElementById('generateSingleBtn');
            const singleConditionsContainer = document.getElementById('singleConditionsContainer');
            const statusSingleDiv = document.getElementById('statusSingle');
            
            // --- CONDITIONS PAR DÉFAUT ---
            const defaultConditions = [
                "Compléter le dossier Administratif conformément à l'article N°05 du règlement de consultation.",
            ];
            
            // --- FONCTIONS UTILITAIRES ---
            
            /**
             * Ajoute un champ de condition modifiable dans un conteneur.
             * @param {HTMLElement} container - Le div qui contiendra les champs de condition.
             * @param {string} text - Le texte pré-rempli pour la condition.
             */
            function addConditionField(container, text = '') {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'condition-item';
                
                const textArea = document.createElement('input');
                textArea.type = 'text';
                textArea.className = 'form-control condition-input';
                textArea.value = text;
                
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'btn btn-danger btn-sm remove-condition';
                removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
                removeBtn.title = 'Supprimer cette condition';
                removeBtn.onclick = () => {
                    if (container.querySelectorAll('.condition-item').length > 1) {
                        itemDiv.remove();
                    } else {
                        alert('Vous devez avoir au moins une condition.');
                    }
                };
                
                itemDiv.appendChild(textArea);
                itemDiv.appendChild(removeBtn);
                container.appendChild(itemDiv);
            }
            
            /**
             * Ajoute une nouvelle ligne de société dans le tableau (mode multi-lot).
             */
            function addSocieteRow() {
                const row = societesTableBody.insertRow();
                row.className = 'societe-row';
                
                // Création des cellules
                const cellName = row.insertCell();
                const cellLots = row.insertCell();
                const cellConditions = row.insertCell();
                const cellNote = row.insertCell();
                const cellActions = row.insertCell();
                
                // Remplissage des cellules
                cellName.innerHTML = `<input type="text" class="form-control companyName" placeholder="Nom de la société">`;
                cellLots.innerHTML = `<textarea class="form-control lots" placeholder="Ex: 1, 2, 15"></textarea><div class="error-message"></div>`;
                
                // Conteneur pour les conditions dynamiques
                const conditionsContainer = document.createElement('div');
                conditionsContainer.className = 'conditions-container';
                cellConditions.appendChild(conditionsContainer);
                
                // Bouton pour ajouter une nouvelle condition pour cette société
                const addBtn = document.createElement('button');
                addBtn.type = 'button';
                addBtn.className = 'btn btn-primary btn-sm';
                addBtn.innerHTML = '<i class="fas fa-plus mr-1"></i> Ajouter une condition';
                addBtn.onclick = () => addConditionField(conditionsContainer);
                cellConditions.appendChild(addBtn);
                
                // Ajouter les conditions par défaut
                defaultConditions.forEach(condText => addConditionField(conditionsContainer, condText));
                
                cellNote.innerHTML = `<textarea class="form-control specific-note" placeholder="Note optionnelle..."></textarea>`;
                cellActions.innerHTML = `<button type="button" class="btn btn-danger btn-sm remove-row"><i class="fas fa-trash"></i></button>`;
                
                row.querySelector('.remove-row').addEventListener('click', () => row.remove());
            }
            
            /**
             * Valide et nettoie les lots, en retournant les erreurs spécifiques.
             */
            function processLots(lotsInput) {
                const lotsRaw = lotsInput.split(',').map(l => l.trim()).filter(l => l !== '');
                let validLots = [];
                let errorMessages = [];
                let hasDuplicate = false;
                
                // Vérifier les doublons dans cette ligne
                const seenInRow = new Set();
                for (const lot of lotsRaw) {
                    if (!/^\d+$/.test(lot)) {
                        errorMessages.push(`'${lot}' n'est pas un chiffre.`);
                    } else {
                        if (seenInRow.has(lot)) {
                            errorMessages.push(`Le lot '${lot}' est un doublon.`);
                            hasDuplicate = true;
                        } else {
                            seenInRow.add(lot);
                            validLots.push(lot);
                        }
                    }
                }
                
                // Vérifier les doublons dans tout le tableau
                const allLots = [];
                const allRows = document.querySelectorAll('.societe-row');
                allRows.forEach(row => {
                    const rowLots = row.querySelector('.lots').value.split(',').map(l => l.trim()).filter(l => l !== '' && /^\d+$/.test(l));
                    allLots.push(...rowLots);
                });
                
                const duplicateLots = allLots.filter((lot, index) => allLots.indexOf(lot) !== index);
                if (duplicateLots.length > 0) {
                    errorMessages.push(`Attention: Le(s) lot(s) ${[...new Set(duplicateLots)].join(', ')} apparaissent plusieurs fois dans le tableau.`);
                    hasDuplicate = true;
                }
                
                validLots.sort((a, b) => a - b);
                return { lots: validLots, error: errorMessages.join(' '), hasDuplicate };
            }
            
            /**
             * Génère le contenu HTML d'une seule page de demande pour une société (mode multi-lot).
             */
            function generateMultiPageHtml(data) {
                const lotsText = data.lots.length > 0 ? `lot N°${data.lots.join(', lot N°')}` : '[AUCUN LOT SPÉCIFIÉ]';
                
                const conditionsHtml = data.conditions.length > 0 
                    ? `<ul>${data.conditions.map(c => `<li style="text-align: justify; margin-bottom: 10px;">${c}</li>`).join('')}</ul>`
                    : '<p>Aucune condition spécifiée.</p>';
                    
                const specificNoteHtml = data.specificNote ? `<p style="text-align: justify; font-weight: bold;">NB :<br>${data.specificNote}</p>` : '';
                
                return `
                    <div class="document-content">
                        
                        <!-- IMAGE D'EN-TÊTE -->
                        <div style="text-align: center; margin-bottom: 10mm;">
                            <img src="https://static.wixstatic.com/media/54eb1f_99f7a17eea9e4456a26645e79509a76d~mv2.png/v1/fill/w_1429,h_176,al_c,lg_1,q_85,enc_auto/54eb1f_99f7a17eea9e4456a26645e79509a76d~mv2.png" alt="En-tête du document" style="width: 100%; max-width: 180mm;">
                        </div>
                        
                        <!-- Reste du contenu du document -->
                        <h1 style="text-align: center; margin: 0; font-size: 18px; color: black;">A</h1>
                        <div style="text-align: center; font-weight: bold; margin: 1px 0 30px 0; font-size: 18px;">Monsieur le Gérant de la société<br> <span style="text-transform: uppercase;">${data.companyName}</span>
                        </div>
                        <p class="subject"><strong><u>Objet : Demande de complément du dossier administratif</u></strong></p>
                       <p><strong><u>Réf : Appel d'Offres N° ${data.refNumber}</u></strong></p>
                        <p style="text-align: justify;"><strong><i>J</strong></i>'ai l'honneur de vous informer que votre offre pour les lots suivants :</p>
                        <p style="text-align: justify; font-weight: bold;"> - ${lotsText}</p>
                        <p style="text-align: justify;">Relative à l'appel d'offres ouvert ${data.offerType} sur offres de prix <b>N° ${data.refNumber}</b> ayant pour objet : "<b>${data.offerObject}</b>", a été retenue provisoirement dans l'attente de :</p>
                        ${conditionsHtml}
                        ${specificNoteHtml}
                        <p style="text-align: justify;"><strong><i>V</strong></i>euillez agréer, Monsieur, l'expression de mes sincères salutations.</p>
                        <p style="text-align: right; margin-top: 40px;">Agadir, le .........................</p>
                        
                        <img src="https://static.wixstatic.com/media/54eb1f_9d983c91a6c34ea1b871e7a357691871~mv2.png/v1/fill/w_1480,h_152,al_c,lg_1,q_85,enc_auto/54eb1f_9d983c91a6c34ea1b871e7a357691871~mv2.png" style="width: 100%; position: absolute; bottom: 3mm; left: 0; padding: 5 10mm; box-sizing: border-box;">
                    </div>`;
            }
            
            /**
             * Génère le contenu HTML pour une demande de lot unique.
             */
            function generateSinglePageHtml(data) {
                const conditionsHtml = data.conditions.length > 0 
                    ? `<ul>${data.conditions.map(c => `<li class="justify-text">${c}.</li>`).join('')}</ul>`
                    : '<p>Aucune condition spécifiée.</p>';
                
                const noteHtml = data.note ? `
                    <p class="justify-text"><strong>NB :</strong></p>
                    <p class="note-content justify-text">${data.note}</p>
                ` : '';
                
                return `
                    <div class="document-content">
                        <div style="text-align: center; margin-bottom: 0px;">
                            <img src="https://static.wixstatic.com/media/54eb1f_99f7a17eea9e4456a26645e79509a76d~mv2.png/v1/fill/w_1429,h_176,al_c,lg_1,q_85,enc_auto/54eb1f_99f7a17eea9e4456a26645e79509a76d~mv2.png" style="width: 100%; max-width: 700px; margin-bottom: 10px;">
                        </div>
                        
                        <div style="text-align: center; font-weight: bold; margin: 30px 0 0 0; font-size: 18px;">
                            <h1 style="margin-top: 30px; margin-bottom: 0; font-size:1.2em; color: black;">A</h1>
                            Monsieur le Gérant de la société<br> <span style="text-transform: uppercase;">${data.companyName}</span>
                        </div>
                        
                        <p style="text-align: left; font-weight: bold; margin: 15px 0;"><strong><u>Objet : Demande de complément du dossier administratif</u></strong></p>
                        <p style="text-align: left; margin: 15px 0;"><strong><u>Réf : Appel d'Offres N° ${data.refNumber}</strong></p></u>
                        <p style="text-align: justify;"><strong><i>J</strong></i>'ai l'honneur de vous informer que votre offre relative à l'appel d'offres ouvert ${data.offerType} ${data.pricingType} <strong> N° ${data.refNumber}</strong> ayant pour objet : "<strong>${data.offerObject}</strong>", a été retenue provisoirement dans l'attente de :</p>
                        
                        ${conditionsHtml}
                        ${noteHtml}
                        
                        <p style="text-align: justify; margin-top: 30px;"><strong><i>V</strong></i>euillez agréer, Monsieur, l'expression de mes sincères salutations.</p>
                        <div style="text-align: right; margin-top: 50px;">
                            Agadir, le .........................
                        </div>
                        
                        <img src="https://static.wixstatic.com/media/54eb1f_9d983c91a6c34ea1b871e7a357691871~mv2.png/v1/fill/w_1480,h_152,al_c,lg_1,q_85,enc_auto/54eb1f_9d983c91a6c34ea1b871e7a357691871~mv2.png" style="width: 100%; position: absolute; bottom: 3mm; left: 0; padding: 5 10mm; box-sizing: border-box;">
                    </div>`;
            }
            
            /**
             * Fonction pour générer un PDF à partir du HTML.
             */
            async function generatePDF(htmlContent, fileName) {
                const elementToRender = document.createElement('div');
                elementToRender.style.position = 'absolute';
                elementToRender.style.left = '-9999px';
                elementToRender.style.width = '210mm';
                elementToRender.innerHTML = htmlContent;
                document.body.appendChild(elementToRender);
                
                const content = elementToRender.querySelector('.document-content');
                
                const options = {
                    scale: 3,
                    useCORS: true,
                    logging: false
                };
                
                try {
                    const canvas = await html2canvas(content, options);
                    const doc = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });
                    
                    const pageHeight = doc.internal.pageSize.getHeight();
                    const pageWidth = doc.internal.pageSize.getWidth();
                    
                    const imgData = canvas.toDataURL('image/png');
                    const canvasAspectRatio = canvas.height / canvas.width;
                    const contentHeight = pageWidth * canvasAspectRatio;
                    
                    let heightInPdf = contentHeight > pageHeight ? pageHeight : contentHeight;
                    doc.addImage(imgData, 'PNG', 0, 0, pageWidth, heightInPdf);
                    
                    doc.save(fileName);
                    document.body.removeChild(elementToRender);
                    return true;
                } catch (error) {
                    console.error('Erreur lors de la génération du PDF :', error);
                    document.body.removeChild(elementToRender);
                    return false;
                }
            }
            
            /**
             * Fonction principale pour générer le PDF multi-pages (mode multi-lot).
             */
            async function generateMultiPagePDF() {
                statusMultiDiv.textContent = 'Validation des données...';
                const commonData = {
                    refNumber: document.getElementById('refNumber').value.trim(),
                    offerType: document.getElementById('offerType').value,
                    offerObject: document.getElementById('offerObject').value.trim(),
                };
                
                if (!commonData.refNumber || !commonData.offerObject) {
                    alert("Veuillez remplir les informations de l'appel d'offres (N° et Objet).");
                    statusMultiDiv.textContent = '';
                    return;
                }
                
                const rows = document.querySelectorAll('.societe-row');
                if (rows.length === 0) {
                    alert("Veuillez ajouter au moins une société.");
                    statusMultiDiv.textContent = '';
                    return;
                }
                
                const allCompanyData = [];
                let isValid = true;
                let hasDuplicateLots = false;
                
                rows.forEach((row) => {
                    const companyName = row.querySelector('.companyName').value.trim();
                    const lotsInput = row.querySelector('.lots').value;
                    const errorDiv = row.querySelector('.error-message');
                    
                    const lotProcessingResult = processLots(lotsInput);
                    errorDiv.textContent = lotProcessingResult.error;
                    
                    // Récupérer les conditions depuis les textareas
                    const conditions = Array.from(row.querySelectorAll('.condition-input'))
                                          .map(input => input.value.trim())
                                          .filter(text => text);
                    
                    const specificNote = row.querySelector('.specific-note').value.trim();
                    
                    if (!companyName || lotProcessingResult.lots.length === 0 || conditions.length === 0 || lotProcessingResult.error) {
                        isValid = false;
                        row.style.backgroundColor = '#ffdddd';
                    } else {
                        row.style.backgroundColor = '';
                        allCompanyData.push({ ...commonData, companyName, lots: lotProcessingResult.lots, conditions, specificNote });
                    }
                    
                    if (lotProcessingResult.hasDuplicate) {
                        hasDuplicateLots = true;
                    }
                });
                
                if (!isValid) {
                    alert("Vérifiez les lignes en rouge. Chaque société doit avoir un nom, au moins un lot valide, et au moins une condition.");
                    statusMultiDiv.textContent = 'Erreur de validation.';
                    return;
                }
                
                if (hasDuplicateLots) {
                    alert("Des numéros de lot sont en doublon dans le tableau. Veuillez corriger avant de générer le PDF.");
                    statusMultiDiv.textContent = 'Erreur: doublons détectés dans les numéros de lot.';
                    return;
                }
                
                statusMultiDiv.textContent = 'Génération du PDF en cours... Veuillez patienter.';
                
                const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                
                for (let i = 0; i < allCompanyData.length; i++) {
                    const data = allCompanyData[i];
                    statusMultiDiv.textContent = `Génération de la page ${i + 1}/${allCompanyData.length} pour ${data.companyName}...`;
                    
                    const htmlContent = generateMultiPageHtml(data);
                    const tempDiv = document.createElement('div');
                    tempDiv.style.position = 'absolute';
                    tempDiv.style.left = '-9999px';
                    tempDiv.style.width = '210mm';
                    tempDiv.innerHTML = htmlContent;
                    document.body.appendChild(tempDiv);
                    
                    const canvas = await html2canvas(tempDiv.querySelector('.document-content'), { 
                        scale: 3,
                        useCORS: true
                    });
                    
                    const imgData = canvas.toDataURL('image/png');
                    
                    if (i > 0) doc.addPage();
                    
                    doc.addImage(imgData, 'PNG', 0, 0, 210, 297, undefined, 'FAST');
                    document.body.removeChild(tempDiv);
                }
                
                doc.save(`demandes_complement_${commonData.refNumber.replace(/[\/\\?%*:|"<>]/g, '-')}.pdf`);
                statusMultiDiv.textContent = 'PDF généré avec succès !';
            }
            
            /**
             * Fonction principale pour générer le PDF (mode single-lot).
             */
            async function generateSinglePagePDF() {
                const companyName = document.getElementById('singleCompanyName').value.trim();
                const refNumber = document.getElementById('singleRefNumber').value.trim();
                const offerType = document.getElementById('singleOfferType').value;
                const pricingType = document.getElementById('pricingType').value;
                const offerObject = document.getElementById('singleOfferObject').value.trim();
                const note = document.getElementById('singleNote').value.trim();
                
                if (!companyName || !refNumber || !offerObject) {
                    alert('Veuillez remplir tous les champs obligatoires (Nom de la société, Numéro de référence, Objet).');
                    return;
                }
                
                const conditionInputs = document.querySelectorAll('#singleConditionsContainer .condition-input');
                const conditions = Array.from(conditionInputs)
                    .map(input => input.value.trim())
                    .filter(condition => condition);
                
                if (conditions.length === 0) {
                    alert('Veuillez saisir au moins une condition.');
                    return;
                }
                
                statusSingleDiv.textContent = 'Génération du PDF en cours... Veuillez patienter.';
                
                const data = {
                    companyName,
                    refNumber,
                    offerType,
                    pricingType,
                    offerObject,
                    conditions,
                    note
                };
                
                const htmlContent = generateSinglePageHtml(data);
                const fileName = `Complement_dossier_${companyName.replace(/ /g, '_')}_${refNumber.replace(/\//g, '-')}.pdf`;
                
                const success = await generatePDF(htmlContent, fileName);
                
                if (success) {
                    statusSingleDiv.textContent = 'PDF généré avec succès !';
                } else {
                    statusSingleDiv.textContent = 'Erreur lors de la génération du PDF.';
                }
            }
            
            // --- INITIALISATION & ÉCOUTEURS D'ÉVÉNEMENTS ---
            
            // Mode selection
            multiLotBtn.addEventListener('click', function() {
                multiLotBtn.classList.add('active');
                singleLotBtn.classList.remove('active');
                multiLotSection.classList.remove('hidden');
                singleLotSection.classList.add('hidden');
            });
            
            singleLotBtn.addEventListener('click', function() {
                singleLotBtn.classList.add('active');
                multiLotBtn.classList.remove('active');
                singleLotSection.classList.remove('hidden');
                multiLotSection.classList.add('hidden');
            });
            
            // Multi-lot mode
            addSocieteBtn.addEventListener('click', addSocieteRow);
            generateMultiBtn.addEventListener('click', generateMultiPagePDF);
            
            // Single-lot mode
            addConditionBtn.addEventListener('click', function() {
                addConditionField(singleConditionsContainer);
            });
            
            // Add remove listeners for initial condition items
            document.querySelectorAll('#singleConditionsContainer .remove-condition').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (singleConditionsContainer.querySelectorAll('.condition-item').length > 1) {
                        this.closest('.condition-item').remove();
                    } else {
                        alert('Vous devez avoir au moins une condition.');
                    }
                });
            });
            
            generateSingleBtn.addEventListener('click', generateSinglePagePDF);
            
            // Initialisation de l'interface
            addSocieteRow(); // Ajouter une première ligne par défaut pour le mode multi-lot
        }
    </script>
</body>
</html>